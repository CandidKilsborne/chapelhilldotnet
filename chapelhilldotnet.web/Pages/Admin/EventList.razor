@page "/admin/events"
@inject IEventService EventService
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation

<div class="min-h-screen bg-gray-100 dark:bg-gray-900">
    <!-- Admin Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Event Management</h1>
                @if (!string.IsNullOrEmpty(_currentUser))
                {
                    <span class="text-sm text-gray-600 dark:text-gray-400">Welcome, @_currentUser</span>
                }
            </div>
            <div class="flex items-center space-x-4">
                <a href="/" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                    View Site
                </a>
                <button 
                    type="button"
                    @onclick="HandleLogout" 
                    class="px-4 py-2 text-sm text-white bg-red-600 hover:bg-red-700 rounded-md"
                    aria-label="Logout from admin panel">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        @if (_isLoading)
        {
            <div class="text-center py-12">
                <p class="text-gray-600 dark:text-gray-400">Loading events...</p>
            </div>
        }
        else
        {
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">All Events</h2>
                <a 
                    href="/admin/events/new" 
                    class="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md inline-flex items-center"
                    aria-label="Add new event">
                    <span class="mr-2">+</span> Add New Event
                </a>
            </div>

            @if (!_events.Any())
            {
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                    <p class="text-gray-600 dark:text-gray-400">No events found. Create your first event!</p>
                </div>
            }
            else
            {
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                    <table class="w-full" aria-label="Events management table">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Title
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Date
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Location
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Attendees
                                </th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                            @foreach (var evt in _events)
                            {
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-6 py-4 text-gray-900 dark:text-white">
                                        <div class="font-medium">@evt.Title</div>
                                        @if (!string.IsNullOrEmpty(evt.Description))
                                        {
                                            <div class="text-sm text-gray-500 dark:text-gray-400 truncate max-w-md">@evt.Description</div>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-gray-900 dark:text-white whitespace-nowrap">
                                        <time datetime="@evt.Date.ToString("yyyy-MM-dd")">@evt.Date.ToShortDateString()</time>
                                        @if (!string.IsNullOrEmpty(evt.Time))
                                        {
                                            <div class="text-sm text-gray-500 dark:text-gray-400">@evt.Time</div>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-gray-900 dark:text-white">@evt.Location</td>
                                    <td class="px-6 py-4 text-gray-900 dark:text-white">@evt.Attendees</td>
                                    <td class="px-6 py-4 text-right space-x-2">
                                        <a 
                                            href="/admin/events/edit/@evt.Id" 
                                            class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300"
                                            aria-label="Edit event @evt.Title">
                                            Edit
                                        </a>
                                        <button 
                                            type="button"
                                            @onclick="() => ConfirmDelete(evt)" 
                                            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300"
                                            aria-label="Delete event @evt.Title">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    </main>
</div>

@if (_showDeleteConfirm && _eventToDelete != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick:stopPropagation="true">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4" role="dialog" aria-labelledby="delete-title" aria-modal="true">
            <h3 id="delete-title" class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Confirm Delete</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                Are you sure you want to delete "@_eventToDelete.Title"? This action cannot be undone.
            </p>
            <div class="flex justify-end space-x-3">
                <button 
                    type="button"
                    @onclick="CancelDelete" 
                    class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md">
                    Cancel
                </button>
                <button 
                    type="button"
                    @onclick="DeleteEvent" 
                    class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-md">
                    Delete
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<Event> _events = new();
    private string? _currentUser;
    private bool _isLoading = true;
    private bool _showDeleteConfirm;
    private Event? _eventToDelete;

    protected override async Task OnInitializedAsync()
    {
        // Check authentication
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/admin/login");
            return;
        }

        _currentUser = await AuthService.GetCurrentUserAsync();
        await LoadEvents();
    }

    private async Task LoadEvents()
    {
        _isLoading = true;
        _events = await EventService.GetAllEventsAsync();
        _isLoading = false;
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/admin/login");
    }

    private void ConfirmDelete(Event evt)
    {
        _eventToDelete = evt;
        _showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        _eventToDelete = null;
        _showDeleteConfirm = false;
    }

    private async Task DeleteEvent()
    {
        if (_eventToDelete != null)
        {
            await EventService.DeleteEventAsync(_eventToDelete.Id);
            await LoadEvents();
        }
        
        _eventToDelete = null;
        _showDeleteConfirm = false;
    }
}
